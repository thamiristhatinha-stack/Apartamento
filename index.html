<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Apzinho 92 - Thamirinha & Felipinho</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/canvas-confetti@1.6.0/dist/confetti.browser.min.js"></script>
    
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, signInWithCustomToken, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, doc, onSnapshot, setDoc } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        const firebaseConfig = typeof __firebase_config !== 'undefined' ? JSON.parse(__firebase_config) : {
            apiKey: "AIzaSyAeFtVA7Yg-DD8knaa9OxCPSoRnBKiUINk",
            authDomain: "apartamento-d328e.firebaseapp.com",
            projectId: "apartamento-d328e",
            storageBucket: "apartamento-d328e.firebasestorage.app",
            messagingSenderId: "206733797802",
            appId: "1:206733797802:web:52fe508854e1c0d09d63d3"
        };

        const appId = typeof __app_id !== 'undefined' ? __app_id : 'apartamento-d328e-prod';
        const docPath = ["artifacts", appId, "public", "data", "finance_tracker", "finance-main"];

        // Cronograma exato extraído do documento CAIXA
        const cronogramaOficial = [
            { etapa: 1, data: '26/09/2025', percMes: 4.20, percAcum: 4.20, pago: true, valorPago: 184.57 },
            { etapa: 2, data: '21/10/2025', percMes: 2.10, percAcum: 6.30, pago: true, valorPago: 224.90 },
            { etapa: 3, data: '21/11/2025', percMes: 1.01, percAcum: 7.31, pago: true, valorPago: 274.23 },
            { etapa: 4, data: '22/12/2025', percMes: 1.88, percAcum: 9.19, pago: true, valorPago: 287.42 },
            { etapa: 5, data: '22/01/2026', percMes: 0.01, percAcum: 9.20 },
            { etapa: 6, data: '22/02/2026', percMes: 3.50, percAcum: 12.70 },
            { etapa: 7, data: '22/03/2026', percMes: 2.00, percAcum: 14.70 },
            { etapa: 8, data: '22/04/2026', percMes: 3.20, percAcum: 17.90 },
            { etapa: 9, data: '22/05/2026', percMes: 6.50, percAcum: 24.40 },
            { etapa: 10, data: '22/06/2026', percMes: 7.40, percAcum: 31.80 },
            { etapa: 11, data: '22/07/2026', percMes: 6.10, percAcum: 37.90 },
            { etapa: 12, data: '22/08/2026', percMes: 2.10, percAcum: 40.00 },
            { etapa: 13, data: '22/09/2026', percMes: 2.70, percAcum: 42.70 },
            { etapa: 14, data: '22/10/2026', percMes: 2.70, percAcum: 45.40 },
            { etapa: 15, data: '22/11/2026', percMes: 3.20, percAcum: 48.60 },
            { etapa: 16, data: '22/12/2026', percMes: 3.70, percAcum: 52.30 },
            { etapa: 17, data: '22/01/2027', percMes: 3.30, percAcum: 55.60 },
            { etapa: 18, data: '22/02/2027', percMes: 3.50, percAcum: 59.10 },
            { etapa: 19, data: '22/03/2027', percMes: 4.25, percAcum: 63.35 },
            { etapa: 20, data: '22/04/2027', percMes: 4.25, percAcum: 67.60 },
            { etapa: 21, data: '23/05/2027', percMes: 4.50, percAcum: 72.10 },
            { etapa: 22, data: '22/06/2027', percMes: 3.50, percAcum: 75.60 },
            { etapa: 23, data: '22/07/2027', percMes: 4.65, percAcum: 80.25 },
            { etapa: 24, data: '22/08/2027', percMes: 4.00, percAcum: 84.25 },
            { etapa: 25, data: '22/09/2027', percMes: 2.35, percAcum: 86.60 },
            { etapa: 26, data: '22/10/2027', percMes: 1.15, percAcum: 87.75 },
            { etapa: 27, data: '22/11/2027', percMes: 1.20, percAcum: 88.95 },
            { etapa: 28, data: '22/12/2027', percMes: 1.10, percAcum: 90.05 },
            { etapa: 29, data: '24/01/2028', percMes: 1.00, percAcum: 91.05 },
            { etapa: 30, data: '22/02/2028', percMes: 0.75, percAcum: 91.80 },
            { etapa: 31, data: '22/03/2028', percMes: 0.50, percAcum: 92.30 },
            { etapa: 32, data: '24/04/2028', percMes: 0.65, percAcum: 92.95 },
            { etapa: 33, data: '22/05/2028', percMes: 0.80, percAcum: 93.75 },
            { etapa: 34, data: '22/06/2028', percMes: 0.65, percAcum: 94.40 },
            { etapa: 35, data: '24/07/2028', percMes: 0.60, percAcum: 95.00 },
            { etapa: 36, data: '22/08/2028', percMes: 5.00, percAcum: 100.00 }
        ];

        let firebaseApp, auth, db;
        
        const defaultData = {
            config: {
                valorApartamento: 255883.47,
                totalFinanciamento: 218149.62,
                totalEntrada: 37733.85,
                saldoInicial: 4999.90
            },
            payments: cronogramaOficial.map(item => ({
                month: item.data.split('/')[1] + '/' + item.data.split('/')[2].slice(-2),
                entrada_pago: 0,
                evo_pago: item.valorPago || 0
            })),
            anuais: [
                { id: 1, label: 'Anual 1 (Dez/25)', valor: 2500.00, pago: true },
                { id: 2, label: 'Anual 2 (Dez/26)', valor: 2500.00, pago: false },
                { id: 3, label: 'Anual 3 (Dez/27)', valor: 2500.00, pago: false }
            ],
            poupanca: { valorAtual: 0 }
        };

        let currentData = defaultData;
        let showAllEvo = false;
        let showAllEntrada = false;

        window.saveDataCloud = async function() {
            if (!auth?.currentUser) return;
            try { await setDoc(doc(db, ...docPath), currentData); } catch (e) { console.error(e); }
        };

        window.toggleShowAllEvo = () => { showAllEvo = !showAllEvo; renderAll(); };
        window.toggleShowAllEntrada = () => { showAllEntrada = !showAllEntrada; renderAll(); };

        window.updateField = (i, field, val) => {
            currentData.payments[i][field] = parseFloat(val) || 0;
            window.saveDataCloud();
            renderAll();
        };

        window.updateCofrinho = (val) => {
            currentData.poupanca.valorAtual = parseFloat(val) || 0;
            window.saveDataCloud();
            renderAll();
        };

        window.toggleAnual = (idx) => {
            currentData.anuais[idx].pago = !currentData.anuais[idx].pago;
            if(currentData.anuais[idx].pago) confetti({ particleCount: 40, colors: ['#fbbf24'] });
            window.saveDataCloud();
            renderAll();
        };

        async function initApp() {
            try {
                firebaseApp = initializeApp(firebaseConfig);
                auth = getAuth(firebaseApp);
                db = getFirestore(firebaseApp);
                const login = async () => {
                    if (typeof __initial_auth_token !== 'undefined' && __initial_auth_token) {
                        await signInWithCustomToken(auth, __initial_auth_token);
                    } else { await signInAnonymously(auth); }
                };
                await login();
                onAuthStateChanged(auth, (user) => {
                    if (user) {
                        onSnapshot(doc(db, ...docPath), (snap) => {
                            if (snap.exists()) { currentData = snap.data(); renderAll(); }
                            else { window.saveDataCloud(); }
                        }, (err) => console.error(err));
                    }
                });
            } catch (e) { console.error(e); }
        }

        window.addEventListener('load', initApp);
        window.getAppData = () => currentData;
        window.getCronograma = () => cronogramaOficial;
        window.getShowStates = () => ({ showAllEvo, showAllEntrada });
    </script>

    <style>
        @import url('https://fonts.googleapis.com/css2?family=Montserrat:wght@700;900&family=Nunito:wght@400;600;800&display=swap');
        :root { --pink-primary: #ec4899; --purple-primary: #a855f7; }
        body { font-family: 'Nunito', sans-serif; background-color: #fff5f7; color: #4a5568; overflow-x: hidden; }
        .bg-header { background: linear-gradient(135deg, var(--purple-primary) 0%, var(--pink-primary) 100%); }
        .card-shadow { box-shadow: 0 10px 30px -5px rgba(168, 85, 247, 0.15); border-radius: 1.5rem; }
        .input-editable { background: rgba(255,255,255,0.6); border: 1px solid #fee2e2; border-radius: 10px; padding: 6px; width: 100%; text-align: center; font-size: 13px; font-weight: 800; color: #333; }
        .progress-container { height: 48px; background: #fdf2f8; border-radius: 16px; overflow: hidden; border: 3px solid #fce7f3; }
        .progress-fill { height: 100%; background: linear-gradient(90deg, var(--pink-primary), var(--purple-primary)); transition: width 1s ease; }
        .floating-nav { position: fixed; bottom: 20px; left: 50%; transform: translateX(-50%); background: rgba(0,0,0,0.8); backdrop-filter: blur(8px); padding: 8px 20px; border-radius: 30px; z-index: 100; display: flex; gap: 20px; box-shadow: 0 10px 25px rgba(0,0,0,0.2); }
        .floating-nav a { color: white; font-size: 18px; opacity: 0.6; }
        .medido-badge { background: #dcfce7; color: #166534; padding: 2px 8px; border-radius: 6px; font-size: 10px; font-weight: 900; }
        .previsto-badge { background: #eff6ff; color: #1e40af; padding: 2px 8px; border-radius: 6px; font-size: 10px; font-weight: 900; }
        .btn-toggle { font-size: 10px; font-weight: 900; text-transform: uppercase; padding: 6px 12px; border-radius: 10px; transition: all 0.2s; }
        .item-glow { filter: drop-shadow(0 0 12px rgba(255, 255, 255, 0.9)); }
    </style>
</head>
<body class="pb-24">

    <header class="bg-header text-white pb-20 pt-12 px-4 rounded-b-[4rem] text-center shadow-2xl relative">
        <div class="mb-4 flex justify-center items-center gap-4">
            <div class="relative">
                <i class="fas fa-user-friends text-5xl item-glow"></i>
                <i class="fas fa-sparkles absolute -top-2 -right-2 text-yellow-200 animate-pulse"></i>
            </div>
            <div class="relative">
                <i class="fas fa-building text-6xl text-white item-glow"></i>
                <i class="fas fa-star absolute -top-1 -left-2 text-white animate-bounce text-xs"></i>
            </div>
        </div>
        <h1 class="text-4xl font-black mb-1">Apzinho 92</h1>
        <p class="text-white/90 text-[10px] font-black uppercase mb-6 tracking-[0.2em]">Thamirinha & Felipinho</p>
        
        <div class="bg-white/10 backdrop-blur-md mx-auto max-w-sm py-4 px-6 rounded-[2rem] border border-white/20">
            <p class="text-[11px] font-extrabold text-white leading-tight">
                "Entrega o teu caminho ao Senhor; confia nele, e ele tudo fará."<br>
                <span class="text-[9px] opacity-80">(Salmos 37:5)</span>
            </p>
        </div>
    </header>

    <main class="max-w-5xl mx-auto px-4 -mt-12 space-y-8 relative z-10">
        
        <!-- Dashboards Principais -->
        <div class="grid grid-cols-2 gap-4 md:grid-cols-4">
            <div class="bg-white p-5 card-shadow border-b-4 border-pink-400">
                <p class="text-[10px] font-black text-pink-400 uppercase">Total Pago</p>
                <h2 class="text-lg md:text-xl font-black text-gray-800" id="dash-total-pago">R$ 0,00</h2>
            </div>
            <div class="bg-white p-5 card-shadow border-b-4 border-blue-400">
                <p class="text-[10px] font-black text-blue-400 uppercase">Evolução Obra</p>
                <h2 class="text-lg md:text-xl font-black text-gray-800" id="dash-evo-pago">R$ 0,00</h2>
            </div>
            <div class="bg-white p-5 card-shadow border-b-4 border-yellow-400">
                <p class="text-[10px] font-black text-yellow-600 uppercase">No Cofrinho</p>
                <h2 class="text-lg md:text-xl font-black text-gray-800" id="dash-poupanca">R$ 0,00</h2>
            </div>
            <div class="bg-white p-5 card-shadow border-b-4 border-purple-500">
                <p class="text-[10px] font-black text-purple-400 uppercase">Saldo Devedor</p>
                <h2 class="text-lg md:text-xl font-black text-gray-800" id="dash-saldo-devedor">R$ 0,00</h2>
            </div>
        </div>

        <!-- Progresso e Detalhes da Obra -->
        <section id="obra" class="bg-white card-shadow p-8 border border-purple-100">
            <div class="flex justify-between items-center mb-6">
                <div>
                    <h3 class="font-black text-gray-700 text-sm uppercase mb-1">Status Oficial da Obra</h3>
                    <p class="text-[10px] text-gray-400" id="resumo-medicao">Medido em Dez/25: 9.19%</p>
                </div>
                <div id="obra-perc" class="text-4xl font-black text-purple-600">0%</div>
            </div>
            <div class="progress-container mb-6">
                <div id="obra-bar" class="progress-fill" style="width: 0%"></div>
            </div>
            
            <div class="grid grid-cols-1 md:grid-cols-2 gap-6 pt-4 border-t border-gray-100">
                <div class="space-y-3">
                    <div class="flex justify-between text-xs font-bold">
                        <span class="text-gray-400 uppercase">Apartamento:</span>
                        <span class="text-gray-700" id="detalhe-valor-ap">R$ 0,00</span>
                    </div>
                    <div class="flex justify-between text-xs font-bold">
                        <span class="text-gray-400 uppercase">Financiado:</span>
                        <span class="text-purple-600" id="detalhe-valor-finan">R$ 0,00</span>
                    </div>
                </div>
                <div class="space-y-3">
                    <div class="flex justify-between text-xs font-bold">
                        <span class="text-gray-400 uppercase">Total Entrada:</span>
                        <span class="text-pink-500" id="detalhe-valor-entrada">R$ 0,00</span>
                    </div>
                    <div class="flex justify-between text-xs font-bold">
                        <span class="text-gray-400 uppercase">Restante Entrada:</span>
                        <span class="text-red-500" id="detalhe-restante-entrada">R$ 0,00</span>
                    </div>
                </div>
            </div>
        </section>

        <!-- Controle de Entrada -->
        <section id="entrada" class="bg-white card-shadow overflow-hidden border border-pink-50">
            <div class="p-5 bg-gradient-to-r from-pink-50 to-white flex justify-between items-center border-b border-pink-100">
                <div class="flex items-center gap-3">
                    <h4 class="font-black text-pink-600 text-[11px] uppercase tracking-wider">Controle de Entrada</h4>
                    <button onclick="window.toggleShowAllEntrada()" id="btn-show-entrada" class="btn-toggle text-pink-500 bg-pink-100/50 hover:bg-pink-100">
                        Ver mais
                    </button>
                </div>
            </div>
            <div class="overflow-x-auto">
                <table class="w-full text-center">
                    <thead class="bg-gray-50 text-[10px] uppercase text-gray-400 font-black">
                        <tr>
                            <th class="p-4 text-left pl-8">Mês</th>
                            <th class="p-4">Pago</th>
                        </tr>
                    </thead>
                    <tbody id="table-entrada" class="divide-y divide-gray-50"></tbody>
                </table>
            </div>
        </section>

        <!-- Evolução de Obra -->
        <section id="evo" class="bg-white card-shadow overflow-hidden border border-blue-50">
            <div class="p-5 bg-gradient-to-r from-blue-50 to-white flex justify-between items-center">
                <div class="flex items-center gap-3">
                    <h4 class="font-black text-blue-600 text-[11px] uppercase tracking-wider">Evolução de Obra</h4>
                    <button onclick="window.toggleShowAllEvo()" id="btn-show-evo" class="btn-toggle text-blue-500 bg-blue-100/50 hover:bg-blue-100">
                        Ver mais
                    </button>
                </div>
                <div class="text-[9px] text-blue-400 font-bold bg-blue-50 px-2 py-1 rounded">PROJEÇÃO BASEADA NO PAGO</div>
            </div>
            <div class="overflow-x-auto">
                <table class="w-full text-center">
                    <thead class="bg-gray-50 text-[10px] uppercase text-gray-400 font-black">
                        <tr>
                            <th class="p-4 text-left pl-8">Etapa/Data</th>
                            <th class="p-4">% Etapa</th>
                            <th class="p-4">Valor</th>
                            <th class="p-4">Situação</th>
                        </tr>
                    </thead>
                    <tbody id="table-obra-list" class="divide-y divide-gray-50"></tbody>
                </table>
            </div>
        </section>

        <!-- Anuais -->
        <section id="anuais" class="bg-white card-shadow p-6">
            <h3 class="font-black text-[11px] uppercase text-gray-400 mb-6 tracking-widest text-center">Parcelas Anuais</h3>
            <div id="anuais-list" class="grid grid-cols-1 md:grid-cols-3 gap-4"></div>
        </section>

        <!-- Cofrinho -->
        <section id="cofrinho" class="bg-white card-shadow p-8 border-2 border-dashed border-yellow-300">
            <h3 class="font-black text-gray-700 text-sm uppercase mb-4">Poupanca do Apzinho</h3>
            <div class="bg-yellow-50 p-6 rounded-3xl flex items-center gap-4 mb-4">
                <i class="fas fa-piggy-bank text-yellow-500 text-3xl"></i>
                <div class="flex-1">
                    <input type="number" id="input-cofrinho" step="0.01" onchange="window.updateCofrinho(this.value)" class="w-full text-3xl font-black bg-transparent text-yellow-700 border-b-2 border-yellow-200 focus:outline-none" placeholder="0,00">
                </div>
            </div>
            <div class="text-center">
                <p class="text-xs font-black text-yellow-600 italic uppercase">"O pouco com Deus torna-se muito."</p>
            </div>
        </section>
    </main>

    <nav class="floating-nav">
        <a href="#entrada"><i class="fas fa-wallet"></i></a>
        <a href="#evo"><i class="fas fa-chart-line"></i></a>
        <a href="#anuais"><i class="fas fa-calendar"></i></a>
        <a href="#cofrinho"><i class="fas fa-piggy-bank"></i></a>
    </nav>

    <script>
        const fmt = (v) => new Intl.NumberFormat('pt-BR', { style: 'currency', currency: 'BRL' }).format(v || 0);

        function renderAll() {
            const data = window.getAppData();
            const cronograma = window.getCronograma();
            const { showAllEvo, showAllEntrada } = window.getShowStates();
            if(!data) return;

            // Variáveis de Soma
            let somaEntradaPaga = data.config.saldoInicial || 0;
            let somaEvoPaga = 0;
            let somaAnualPaga = 0;
            
            // Cálculo da Média de Custo por 1% de Obra (Baseado nos 4 meses pagos)
            const mesesPagos = cronograma.filter(c => c.pago);
            const totalPagoEvoHistorico = mesesPagos.reduce((acc, curr) => acc + curr.valorPago, 0);
            const totalPercMedidoHistorico = mesesPagos.reduce((acc, curr) => acc + curr.percMes, 0);
            const custoPorUmPorcento = totalPagoEvoHistorico / totalPercMedidoHistorico;

            // Render Entrada
            const tEntrada = document.getElementById('table-entrada');
            tEntrada.innerHTML = '';
            document.getElementById('btn-show-entrada').textContent = showAllEntrada ? "Ver menos" : "Ver mais";

            data.payments.forEach((p, i) => {
                somaEntradaPaga += (p.entrada_pago || 0);
                if (!showAllEntrada && i > 3) return;
                tEntrada.innerHTML += `
                    <tr>
                        <td class="p-4 text-left pl-8 font-extrabold text-[12px]">${p.month}</td>
                        <td class="p-4"><input type="number" value="${p.entrada_pago}" onchange="window.updateField(${i}, 'entrada_pago', this.value)" class="input-editable text-pink-600"></td>
                    </tr>
                `;
            });

            // Render Evolução
            const tEvo = document.getElementById('table-obra-list');
            tEvo.innerHTML = '';
            document.getElementById('btn-show-evo').textContent = showAllEvo ? "Ver menos" : "Ver mais";

            cronograma.forEach((item, i) => {
                // Se já pagou, usa o valor real. Se não, projeta baseado no custo médio por 1%
                let valorEtapa = item.pago ? item.valorPago : (item.percMes * custoPorUmPorcento);
                somaEvoPaga += valorEtapa;
                
                if (!showAllEvo && i > 3) return;

                const situacao = item.pago ? 'Paga' : 'Prevista';
                const badge = item.pago ? 'medido-badge' : 'previsto-badge';

                tEvo.innerHTML += `
                    <tr class="${item.pago ? 'bg-blue-50/50' : 'opacity-70'}">
                        <td class="p-4 text-left pl-8">
                            <p class="font-black text-[11px] text-gray-700">Etapa ${item.etapa}</p>
                            <p class="text-[10px] text-gray-400 font-bold">${item.data}</p>
                        </td>
                        <td class="p-4 font-black text-blue-500 text-[11px]">${item.percMes.toFixed(2)}%</td>
                        <td class="p-4 font-black text-gray-700 text-[12px]">${fmt(valorEtapa)}</td>
                        <td class="p-4">
                            <span class="${badge}">${situacao}</span>
                        </td>
                    </tr>
                `;
            });

            // Render Anuais
            const aList = document.getElementById('anuais-list');
            aList.innerHTML = '';
            data.anuais.forEach((a, idx) => {
                if(a.pago) somaAnualPaga += a.valor;
                aList.innerHTML += `
                    <div onclick="window.toggleAnual(${idx})" class="p-4 rounded-2xl border-2 cursor-pointer transition-all ${a.pago ? 'bg-green-50 border-green-200' : 'bg-white border-gray-100'}">
                        <div class="flex justify-between items-center">
                            <div>
                                <p class="text-[9px] font-black uppercase text-gray-400">${a.label}</p>
                                <p class="text-sm font-black">${fmt(a.valor)}</p>
                            </div>
                            <i class="fas ${a.pago ? 'fa-check-circle text-green-600' : 'fa-circle text-gray-100'}"></i>
                        </div>
                    </div>
                `;
            });

            // Cálculos Finais de Contrato
            const totalGeralPago = somaEntradaPaga + somaEvoPaga + somaAnualPaga;
            const saldoDevedor = data.config.valorApartamento - totalGeralPago;
            const percQuitado = (totalGeralPago / data.config.valorApartamento) * 100;
            const restanteEntrada = data.config.totalEntrada - somaEntradaPaga;

            // Dashboards
            document.getElementById('dash-total-pago').textContent = fmt(totalGeralPago);
            document.getElementById('dash-evo-pago').textContent = fmt(somaEvoPaga);
            document.getElementById('dash-poupanca').textContent = fmt(data.poupanca.valorAtual);
            document.getElementById('dash-saldo-devedor').textContent = fmt(saldoDevedor);
            document.getElementById('input-cofrinho').value = data.poupanca.valorAtual;

            // Detalhes da Obra
            const percObraReal = 9.19; // Última medição conhecida
            document.getElementById('obra-perc').textContent = percObraReal.toFixed(2) + '%';
            document.getElementById('obra-bar').style.width = percObraReal + '%';
            document.getElementById('resumo-medicao').textContent = `Medido em Dez/25: ${percObraReal}%`;
            
            document.getElementById('detalhe-valor-ap').textContent = fmt(data.config.valorApartamento);
            document.getElementById('detalhe-valor-finan').textContent = fmt(data.config.totalFinanciamento);
            document.getElementById('detalhe-valor-entrada').textContent = fmt(data.config.totalEntrada);
            document.getElementById('detalhe-restante-entrada').textContent = fmt(restanteEntrada);
        }
    </script>
</body>
</html>



