<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Nosso Apzinho 92 - Thamirinha & Felipinho</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/canvas-confetti@1.6.0/dist/confetti.browser.min.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Dancing+Script:wght@700&family=Montserrat:wght@700;900&family=Nunito:wght@400;600;800&display=swap" rel="stylesheet">
    
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, signInWithCustomToken, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, doc, onSnapshot, setDoc } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        const firebaseConfig = typeof __firebase_config !== 'undefined' ? JSON.parse(__firebase_config) : {
            apiKey: "AIzaSyAeFtVA7Yg-DD8knaa9OxCPSoRnBKiUINk",
            authDomain: "apartamento-d328e.firebaseapp.com",
            projectId: "apartamento-d328e",
            storageBucket: "apartamento-d328e.firebasestorage.app",
            messagingSenderId: "206733797802",
            appId: "1:206733797802:web:52fe508854e1c0d09d63d3"
        };

        const appId = typeof __app_id !== 'undefined' ? __app_id : 'apartamento-d328e-prod';
        const docPath = ["artifacts", appId, "public", "data", "finance_tracker", "finance-main"];

        let auth, db;
        
        const defaultData = {
            config: {
                valorApartamento: 255883.47,
                totalFinanciamento: 218149.62,
                totalEntrada: 37733.85,
                percObraMedido: 9.19,
                dataEntregaChaves: "2028-06-01",
                taxaJurosAnual: 9.5
            },
            payments: [
                { month: 'Saldo Inicial', entrada_previsto: 4999.90, entrada_pago: 4999.90 },
                { month: 'Set/25', entrada_previsto: 1018.66, entrada_pago: 1018.66 },
                { month: 'Out/25', entrada_previsto: 1018.66, entrada_pago: 1018.66 },
                { month: 'Nov/25', entrada_previsto: 1018.66, entrada_pago: 1018.66 },
                { month: 'Dez/25', entrada_previsto: 1018.66, entrada_pago: 0 }
            ],
            cronogramaEvo: [
                { etapa: 1, data: '26/09/2025', percMes: 4.20, percAcum: 4.20, pago: true, valorPago: 184.57 },
                { etapa: 2, data: '21/10/2025', percMes: 2.10, percAcum: 6.30, pago: true, valorPago: 224.90 },
                { etapa: 3, data: '21/11/2025', percMes: 1.01, percAcum: 7.31, pago: true, valorPago: 274.23 },
                { etapa: 4, data: '22/12/2025', percMes: 1.88, percAcum: 9.19, pago: true, valorPago: 287.42 },
                { etapa: 5, data: '22/01/2026', percMes: 0.01, percAcum: 9.20, pago: false, valorPago: 0 },
                { etapa: 6, data: '22/02/2026', percMes: 3.50, percAcum: 12.70, pago: false, valorPago: 0 },
                { etapa: 7, data: '22/03/2026', percMes: 2.00, percAcum: 14.70, pago: false, valorPago: 0 },
                { etapa: 8, data: '22/04/2026', percMes: 3.20, percAcum: 17.90, pago: false, valorPago: 0 },
                { etapa: 9, data: '22/05/2026', percMes: 6.50, percAcum: 24.40, pago: false, valorPago: 0 },
                { etapa: 10, data: '22/06/2026', percMes: 7.40, percAcum: 31.80, pago: false, valorPago: 0 },
                { etapa: 11, data: '22/07/2026', percMes: 6.10, percAcum: 37.90, pago: false, valorPago: 0 },
                { etapa: 12, data: '22/08/2026', percMes: 2.10, percAcum: 40.00, pago: false, valorPago: 0 },
                { etapa: 13, data: '22/09/2026', percMes: 2.70, percAcum: 42.70, pago: false, valorPago: 0 },
                { etapa: 14, data: '22/10/2026', percMes: 2.70, percAcum: 45.40, pago: false, valorPago: 0 },
                { etapa: 15, data: '22/11/2026', percMes: 3.20, percAcum: 48.60, pago: false, valorPago: 0 },
                { etapa: 16, data: '22/12/2026', percMes: 3.70, percAcum: 52.30, pago: false, valorPago: 0 },
                { etapa: 17, data: '22/01/2027', percMes: 3.30, percAcum: 55.60, pago: false, valorPago: 0 },
                { etapa: 18, data: '22/02/2027', percMes: 3.50, percAcum: 59.10, pago: false, valorPago: 0 },
                { etapa: 19, data: '22/03/2027', percMes: 4.25, percAcum: 63.35, pago: false, valorPago: 0 },
                { etapa: 20, data: '22/04/2027', percMes: 4.25, percAcum: 67.60, pago: false, valorPago: 0 },
                { etapa: 21, data: '23/05/2027', percMes: 4.50, percAcum: 72.10, pago: false, valorPago: 0 },
                { etapa: 22, data: '22/06/2027', percMes: 3.50, percAcum: 75.60, pago: false, valorPago: 0 },
                { etapa: 23, data: '22/07/2027', percMes: 4.65, percAcum: 80.25, pago: false, valorPago: 0 },
                { etapa: 24, data: '22/08/2027', percMes: 4.00, percAcum: 84.25, pago: false, valorPago: 0 },
                { etapa: 25, data: '22/09/2027', percMes: 2.35, percAcum: 86.60, pago: false, valorPago: 0 },
                { etapa: 26, data: '22/10/2027', percMes: 1.15, percAcum: 87.75, pago: false, valorPago: 0 },
                { etapa: 27, data: '22/11/2027', percMes: 1.20, percAcum: 88.95, pago: false, valorPago: 0 },
                { etapa: 28, data: '22/12/2027', percMes: 1.10, percAcum: 90.05, pago: false, valorPago: 0 },
                { etapa: 29, data: '24/01/2028', percMes: 1.00, percAcum: 91.05, pago: false, valorPago: 0 },
                { etapa: 30, data: '22/02/2028', percMes: 0.75, percAcum: 91.80, pago: false, valorPago: 0 },
                { etapa: 31, data: '22/03/2028', percMes: 0.50, percAcum: 92.30, pago: false, valorPago: 0 },
                { etapa: 32, data: '24/04/2028', percMes: 0.65, percAcum: 92.95, pago: false, valorPago: 0 },
                { etapa: 33, data: '22/05/2028', percMes: 0.80, percAcum: 93.75, pago: false, valorPago: 0 },
                { etapa: 34, data: '22/06/2028', percMes: 0.65, percAcum: 94.40, pago: false, valorPago: 0 },
                { etapa: 35, data: '24/07/2028', percMes: 0.60, percAcum: 95.00, pago: false, valorPago: 0 },
                { etapa: 36, data: '22/08/2028', percMes: 5.00, percAcum: 100.00, pago: false, valorPago: 0 }
            ],
            anuais: [
                { id: 1, label: 'Anual 1 (Dez/25)', valor: 2500.00, pago: true },
                { id: 2, label: 'Anual 2 (Dez/26)', valor: 2500.00, pago: false },
                { id: 3, label: 'Anual 3 (Dez/27)', valor: 2500.00, pago: false }
            ],
            amortizacoes: [],
            poupanca: { valorAtual: 0 }
        };

        window.currentData = defaultData;
        window.showAllEvo = false;

        const frasesMotivacionais = [
            "Cada tijolinho nos aproxima do nosso sonho! üè†‚ú®",
            "Nossa casinha est√° ganhando forma! Orgulho de n√≥s. ‚ù§Ô∏è",
            "Olha s√≥ como nossa obra est√° avan√ßando! Parab√©ns, casal! üöÄ",
            "Mais um passo dado rumo √†s chaves do 92! üîë",
            "Deus √© fiel! Nossa vit√≥ria est√° sendo constru√≠da! üôè"
        ];

        window.saveDataCloud = async function() {
            if (!auth?.currentUser) return;
            try { 
                await setDoc(doc(db, ...docPath), window.currentData); 
                console.log("Dados salvos na nuvem!");
            } catch (e) { 
                console.error("Erro ao salvar:", e); 
            }
        };

        window.getAppData = () => window.currentData;

        window.updateField = (i, field, val) => {
            window.currentData.payments[i][field] = parseFloat(val) || 0;
            window.renderAll();
            window.saveDataCloud();
        };

        window.updateEvoValue = (i, val) => {
            window.currentData.cronogramaEvo[i].valorPago = parseFloat(val) || 0;
            window.renderAll();
            window.saveDataCloud();
        };

        window.toggleEvoPago = (i) => {
            const item = window.currentData.cronogramaEvo[i];
            item.pago = !item.pago;
            if(item.pago) {
                confetti({ particleCount: 150, spread: 80, origin: { y: 0.6 }, colors: ['#f472b6', '#db2777', '#fbbf24'] });
                showToast(frasesMotivacionais[Math.floor(Math.random() * frasesMotivacionais.length)]);
            }
            window.renderAll();
            window.saveDataCloud();
        };

        window.updateObraPerc = (newVal) => {
            window.currentData.config.percObraMedido = parseFloat(newVal) || 0;
            window.renderAll();
            window.saveDataCloud();
        };

        window.updateCofrinho = (val) => { 
            window.currentData.poupanca.valorAtual = parseFloat(val) || 0; 
            window.renderAll();
            window.saveDataCloud(); 
        };

        window.toggleAnual = (idx) => { 
            window.currentData.anuais[idx].pago = !window.currentData.anuais[idx].pago; 
            if(window.currentData.anuais[idx].pago) {
                confetti({ particleCount: 50 });
            }
            window.renderAll(); 
            window.saveDataCloud(); 
        };

        window.toggleShowAllEvo = () => { window.showAllEvo = !window.showAllEvo; window.renderAll(); };

        function showToast(message) {
            const toast = document.getElementById('toast');
            if(!toast) return;
            toast.innerText = message;
            toast.classList.remove('opacity-0', 'translate-y-4');
            toast.classList.add('opacity-100', 'translate-y-0');
            setTimeout(() => {
                toast.classList.add('opacity-0', 'translate-y-4');
                toast.classList.remove('opacity-100', 'translate-y-0');
            }, 4000);
        }

        async function initApp() {
            try {
                const firebaseApp = initializeApp(firebaseConfig);
                auth = getAuth(firebaseApp);
                db = getFirestore(firebaseApp);
                
                const login = async () => {
                    if (typeof __initial_auth_token !== 'undefined' && __initial_auth_token) {
                        await signInWithCustomToken(auth, __initial_auth_token);
                    } else { await signInAnonymously(auth); }
                };
                
                await login();
                
                onAuthStateChanged(auth, (user) => {
                    if (user) {
                        onSnapshot(doc(db, ...docPath), (snap) => {
                            if (snap.exists()) { 
                                window.currentData = snap.data(); 
                                window.renderAll(); 
                            } else { 
                                window.saveDataCloud(); 
                            }
                        }, (err) => console.error("Erro no snapshot:", err));
                    }
                });
            } catch (e) { console.error("Erro na inicializa√ß√£o:", e); }
        }
        window.addEventListener('load', initApp);
    </script>

    <style>
        :root { --pink-light: #fff5f7; --pink-mid: #f472b6; --pink-dark: #db2777; --pink-soft: #fce7f3; }
        body { font-family: 'Nunito', sans-serif; background-color: #fffafb; color: #4a5568; overflow-x: hidden; scroll-behavior: smooth; }
        .modern-header { background: white; padding: 40px 20px; text-align: center; border-bottom: 1px solid var(--pink-soft); }
        .card-shadow { background: white; box-shadow: 0 4px 20px rgba(0, 0, 0, 0.03); border-radius: 2rem; border: 1px solid #f9f9f9; }
        .signature { font-family: 'Dancing Script', cursive; color: var(--pink-mid); }
        .input-editable { background: #fdf2f8; border: 1px solid transparent; border-radius: 10px; padding: 6px; width: 100%; text-align: center; font-size: 14px; font-weight: 700; color: #333; }
        .progress-container { height: 16px; background: #fce7f3; border-radius: 10px; overflow: hidden; }
        .progress-fill { height: 100%; background: linear-gradient(90deg, #f472b6, #db2777); transition: width 1s ease-in-out; }
        .floating-nav { position: fixed; bottom: 20px; left: 50%; transform: translateX(-50%); background: rgba(255, 255, 255, 0.9); backdrop-filter: blur(10px); padding: 10px 20px; border-radius: 30px; z-index: 100; display: flex; gap: 20px; box-shadow: 0 8px 32px rgba(0,0,0,0.08); }
        .floating-nav a { color: #d1d5db; font-size: 18px; width: 40px; height: 40px; display: flex; align-items: center; justify-content: center; }
    </style>
</head>
<body class="pb-32">

    <div id="toast" class="fixed top-8 left-1/2 -translate-x-1/2 z-[200] bg-pink-600 text-white px-6 py-3 rounded-full shadow-2xl font-bold text-sm opacity-0 translate-y-4 transition-all duration-500 pointer-events-none"></div>

    <header class="modern-header">
        <h1 class="text-3xl font-black text-gray-800 tracking-tight">Nosso Apzinho 92</h1>
        <p class="signature text-xl mt-1">Thamirinha & Felipinho</p>
    </header>

    <main class="max-w-4xl mx-auto px-4 mt-8 space-y-6">
        
        <!-- Dashboard Principal -->
        <div class="bg-emerald-500 p-8 card-shadow text-center relative overflow-hidden text-white shadow-xl">
            <p class="text-[10px] font-black text-emerald-100 uppercase tracking-widest mb-2">Total Investido (Entrada + Evo + Anuais)</p>
            <h2 class="text-5xl font-black tracking-tighter" id="dash-total-geral">R$ 0,00</h2>
        </div>

        <!-- Grid de Resumo -->
        <div class="grid grid-cols-2 md:grid-cols-4 gap-4">
            <div class="bg-white p-5 card-shadow text-center">
                <p class="text-[9px] font-black text-gray-400 uppercase">Entrada Paga</p>
                <h3 class="text-lg font-black text-pink-500" id="dash-total-pago">R$ 0,00</h3>
            </div>
            <div class="bg-white p-5 card-shadow text-center">
                <p class="text-[9px] font-black text-gray-400 uppercase">Anuais Pagos</p>
                <h3 class="text-lg font-black text-blue-400" id="dash-total-anuais">R$ 0,00</h3>
            </div>
            <div class="bg-white p-5 card-shadow text-center">
                <p class="text-[9px] font-black text-gray-400 uppercase">No Cofrinho</p>
                <h3 class="text-lg font-black text-orange-500" id="dash-cofrinho-val">R$ 0,00</h3>
            </div>
            <div class="bg-white p-5 card-shadow text-center">
                <p class="text-[9px] font-black text-gray-400 uppercase">Evolu√ß√£o Paga</p>
                <h3 class="text-lg font-black text-emerald-500" id="dash-total-evo">R$ 0,00</h3>
            </div>
        </div>

        <!-- Se√ß√£o de Anuais -->
        <section id="anuais" class="bg-white card-shadow overflow-hidden">
            <div class="p-6 border-b border-gray-50 flex justify-between items-center">
                <h4 class="font-black text-gray-800 text-xs uppercase tracking-widest">Bal√µes / Anuais</h4>
            </div>
            <div id="lista-anuais" class="grid grid-cols-1 md:grid-cols-3 divide-y md:divide-y-0 md:divide-x divide-gray-50"></div>
        </section>

        <!-- Barra de Evolu√ß√£o de Obra -->
        <section class="bg-white card-shadow p-6">
            <div class="flex justify-between items-end mb-4">
                <h3 class="font-black text-gray-800 text-xs uppercase tracking-widest">Progresso da Obra</h3>
                <input type="number" id="input-perc-obra" step="0.01" class="w-16 text-xl font-black text-pink-600 text-right bg-transparent focus:outline-none" onchange="window.updateObraPerc(this.value)">
            </div>
            <div class="progress-container">
                <div id="obra-bar" class="progress-fill" style="width: 0%"></div>
            </div>
        </section>

        <!-- Mensais de Evolu√ß√£o -->
        <section id="evo" class="bg-white card-shadow overflow-hidden">
            <div class="p-6 border-b border-gray-50 flex justify-between items-center">
                <h4 class="font-black text-gray-800 text-xs uppercase tracking-widest">Juros de Evolu√ß√£o</h4>
                <button onclick="window.toggleShowAllEvo()" id="btn-show-evo" class="text-[9px] font-black uppercase text-blue-400 px-3 py-1 bg-blue-50 rounded-full">Ver Tudo</button>
            </div>
            <div class="overflow-x-auto">
                <table class="w-full">
                    <tbody id="table-obra-list" class="divide-y divide-gray-50"></tbody>
                </table>
            </div>
        </section>

        <!-- Plano de Entrada -->
        <section id="entrada" class="bg-white card-shadow overflow-hidden">
            <div class="p-6 border-b border-gray-50">
                <h4 class="font-black text-gray-800 text-xs uppercase tracking-widest">Plano de Entrada</h4>
            </div>
            <table class="w-full">
                <tbody id="table-entrada" class="divide-y divide-gray-50"></tbody>
            </table>
        </section>

        <!-- Cofrinho -->
        <section id="cofrinho" class="bg-white card-shadow p-8 text-center">
            <p class="text-[10px] font-black text-gray-400 uppercase">Reserva Estrat√©gica</p>
            <input type="number" id="input-cofrinho" step="0.01" onchange="window.updateCofrinho(this.value)" class="text-2xl font-black bg-transparent text-gray-800 focus:outline-none text-center">
        </section>

    </main>

    <nav class="floating-nav">
        <a href="#entrada"><i class="fas fa-list-ul"></i></a>
        <a href="#anuais"><i class="fas fa-calendar-alt"></i></a>
        <a href="#evo"><i class="fas fa-chart-line"></i></a>
        <a href="#cofrinho"><i class="fas fa-piggy-bank"></i></a>
    </nav>

    <script>
        const fmt = (v) => new Intl.NumberFormat('pt-BR', { style: 'currency', currency: 'BRL' }).format(v || 0);

        window.renderAll = function() {
            const data = window.getAppData();
            if(!data) return;

            let somaEntradaPaga = 0;
            let somaEvoPaga = 0;
            let somaAnuaisPagos = 0;

            // Anuais
            const divAnuais = document.getElementById('lista-anuais');
            divAnuais.innerHTML = '';
            data.anuais.forEach((an, idx) => {
                if(an.pago) somaAnuaisPagos += an.valor;
                divAnuais.innerHTML += `
                    <div class="p-6 flex flex-col items-center">
                        <p class="text-[9px] font-black text-gray-400 uppercase">${an.label}</p>
                        <h5 class="text-sm font-black ${an.pago ? 'text-blue-500' : 'text-gray-300'}">${fmt(an.valor)}</h5>
                        <button onclick="window.toggleAnual(${idx})" class="mt-3 text-[10px] font-black px-4 py-1 rounded-full border ${an.pago ? 'bg-blue-400 text-white' : 'text-gray-400'}">
                            ${an.pago ? 'PAGO' : 'PENDENTE'}
                        </button>
                    </div>`;
            });

            // Entrada
            const tEntrada = document.getElementById('table-entrada');
            tEntrada.innerHTML = '';
            data.payments.forEach((p, i) => {
                somaEntradaPaga += (p.entrada_pago || 0);
                tEntrada.innerHTML += `
                    <tr>
                        <td class="p-4 text-xs font-black text-gray-600">${p.month}</td>
                        <td class="p-4"><input type="number" value="${p.entrada_pago}" onchange="window.updateField(${i}, 'entrada_pago', this.value)" class="input-editable"></td>
                    </tr>`;
            });

            // Evolu√ß√£o
            const tEvo = document.getElementById('table-obra-list');
            tEvo.innerHTML = '';
            const valFinan = data.config.totalFinanciamento || 218149.62;
            const taxa = (data.config.taxaJurosAnual / 100) / 12;

            data.cronogramaEvo.forEach((item, i) => {
                if(item.pago) somaEvoPaga += (item.valorPago || 0);
                
                const lastPagoIdx = [...data.cronogramaEvo].reverse().findIndex(x => x.pago);
                const actualLastIdx = lastPagoIdx === -1 ? -1 : data.cronogramaEvo.length - 1 - lastPagoIdx;

                if (!window.showAllEvo && i > (actualLastIdx + 4) && !item.pago) return;

                const previsto = (valFinan * (item.percAcum / 100)) * taxa;

                tEvo.innerHTML += `
                    <tr>
                        <td class="p-4">
                            <p class="font-black text-xs text-gray-800">${item.data}</p>
                            <p class="text-[9px] text-gray-400 font-bold">${item.percAcum.toFixed(2)}% obra</p>
                        </td>
                        <td class="p-4">
                            <span class="block text-[8px] text-gray-400 text-center">Prev: ${fmt(previsto)}</span>
                            <input type="number" value="${item.valorPago || 0}" onchange="window.updateEvoValue(${i}, this.value)" class="input-editable ${item.pago ? 'text-blue-600' : ''}">
                        </td>
                        <td class="p-4 text-right">
                            <button onclick="window.toggleEvoPago(${i})" class="w-8 h-8 rounded-full ${item.pago ? 'bg-blue-400 text-white' : 'bg-gray-100 text-gray-300'}">
                                <i class="fas fa-check text-[10px]"></i>
                            </button>
                        </td>
                    </tr>`;
            });

            // Totais Finais
            const totalGeral = somaEntradaPaga + somaEvoPaga + somaAnuaisPagos;
            document.getElementById('dash-total-geral').textContent = fmt(totalGeral);
            document.getElementById('dash-total-pago').textContent = fmt(somaEntradaPaga);
            document.getElementById('dash-total-anuais').textContent = fmt(somaAnuaisPagos);
            document.getElementById('dash-total-evo').textContent = fmt(somaEvoPaga);
            document.getElementById('dash-cofrinho-val').textContent = fmt(data.poupanca.valorAtual);
            
            document.getElementById('obra-bar').style.width = data.config.percObraMedido + '%';
            document.getElementById('input-perc-obra').value = data.config.percObraMedido;
            document.getElementById('input-cofrinho').value = data.poupanca.valorAtual;
            document.getElementById('btn-show-evo').textContent = window.showAllEvo ? "Ocultar" : "Ver Tudo";
        };
    </script>
</body>
</html>





